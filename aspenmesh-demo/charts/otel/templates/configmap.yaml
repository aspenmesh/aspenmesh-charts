---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.otelCollector.collectorConfig.name }}
  namespace: {{ .Values.namespace }}
data:
  collector.yaml: |
    receivers:
      {{- if .Values.otelCollector.collectorConfig.enableOtlpReceiver }}
      otlp:
        protocols:
          {{- toYaml .Values.otelCollector.collectorConfig.otlpReceiver.protocols | nindent 12 }}
      {{- end}}
      {{- if .Values.otelCollector.collectorConfig.enablePrometheusSimpleReceiver }}
      prometheus_simple:
        endpoint: {{ .Values.otelCollector.collectorConfig.prometheusSimpleReceiver.endpoint }}
        collection_interval: {{ .Values.otelCollector.collectorConfig.prometheusSimpleReceiver.collectionInterval }}
        metrics_path: {{ .Values.otelCollector.collectorConfig.prometheusSimpleReceiver.metricsPath }}
        params:
            match[]:
            {{- toYaml .Values.otelCollector.collectorConfig.prometheusSimpleReceiver.matchParams | nindent 12 }}
      {{- end }}
      {{- if .Values.otelCollector.collectorConfig.enablePrometheusReceiver }}
      prometheus:
        config:
          scrape_configs:
            {{- toYaml .Values.otelCollector.collectorConfig.prometheusReceiver.scrapeConfigs | nindent 12 }}
      {{- end }}
    processors:
      resourcedetection/eks:
        detectors: [env, eks]
        timeout: 2s
        override: false
      resourcedetection/aks:
        detectors: [env, aks]
        timeout: 2s
        override: false
      resourcedetection/gke:
        detectors: [env, gke]
        timeout: 2s
        override: false
    exporters:
      {{- if .Values.otelCollector.collectorConfig.enableLoggingExporter }}
      logging:
        loglevel: {{ .Values.otelCollector.collectorConfig.loggingExporter.logLevel }}
      {{- end }}
      {{- if .Values.otelCollector.collectorConfig.enablePrometheusRemoteWriteExporter }}
      prometheusremotewrite:
        endpoint: {{ .Values.otelCollector.collectorConfig.prometheusRemoteWriteExporter.endpoint }}
        external_labels:
          {{- toYaml .Values.otelCollector.collectorConfig.prometheusRemoteWriteExporter.externalLabels | nindent 12}}
        timeout: {{ .Values.otelCollector.collectorConfig.prometheusRemoteWriteExporter.timeout }}
        headers:
          {{- toYaml .Values.otelCollector.collectorConfig.prometheusRemoteWriteExporter.headers | nindent 12}}
      {{- end }}
    service:
      pipelines:
        metrics:
         receivers: {{- toYaml .Values.otelCollector.collectorConfig.metrics.receivers | nindent 12 }}
         processors: {{- toYaml .Values.otelCollector.collectorConfig.metrics.processors | nindent 12}}
         exporters: {{- toYaml .Values.otelCollector.collectorConfig.metrics.exporters | nindent 12}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.otelAgent.agentConfig.name }}
  namespace: {{ .Values.namespace}}
data:
  agent.yaml: |
    receivers:
      {{- if .Values.otelAgent.agentConfig.enableOtlpReceiver }}
      otlp:
        protocols:
          {{- toYaml .Values.otelAgent.agentConfig.otlpReceiver.protocols | nindent 12 }}
      {{- end}}
    processors:
    exporters:
      {{- if .Values.otelAgent.agentConfig.enableLoggingExporter }}
      logging:
        loglevel: {{ .Values.otelAgent.agentConfig.loggingExporter.logLevel }}
      {{- end }}
      {{- if .Values.otelAgent.agentConfig.enableOtlpExporter }}
      otlp:
        endpoint: {{ .Values.otelAgent.agentConfig.otlpExporter.endpoint }}
        tls:
          insecure: {{ .Values.otelAgent.agentConfig.otlpExporter.insecure }}
      {{- end }}
    service:
      pipelines:
        traces:
          receivers: {{- toYaml .Values.otelAgent.agentConfig.traces.receivers | nindent 12 }}
          processors: {{- toYaml .Values.otelAgent.agentConfig.traces.processors | nindent 12}}
          exporters: {{- toYaml .Values.otelAgent.agentConfig.traces.exporters | nindent 12}}
        metrics:
          receivers: {{- toYaml .Values.otelAgent.agentConfig.metrics.receivers | nindent 12 }}
          processors: {{- toYaml .Values.otelAgent.agentConfig.metrics.processors | nindent 12}}
          exporters: {{- toYaml .Values.otelAgent.agentConfig.metrics.exporters | nindent 12}}
